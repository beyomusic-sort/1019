<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --accent: #007aff;
      --bg: #f4f4f8;
      --card-radius: 18px;
      --shadow-soft: 0 5px 20px rgba(0,0,0,0.05);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      background: var(--bg);
      display: flex;
      justify-content: center;
      min-height: 100vh;
    }

    .app {
      width: 100%;
      max-width: 560px;
      padding: 16px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .card {
      background: #fff;
      border-radius: var(--card-radius);
      box-shadow: var(--shadow-soft);
      padding: 22px 18px 24px;
    }

    h1 {
      text-align: center;
      font-size: 1.8rem;
      margin: 4px 0 10px;
      letter-spacing: 0.06em;
      line-height: 1.3;
    }

    .sub {
      text-align: center;
      font-size: 0.9rem;
      color: #444;
      margin: 0 4px;
      line-height: 1.5;
    }

    .note {
      text-align: center;
      font-size: 0.7rem;
      color: #666;
      margin-top: 10px;
      line-height: 1.5;
      opacity: 0.9;
    }

    .mode-buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
      align-items: center;
    }

    .btn {
      border-radius: 999px;
      padding: 12px 18px;
      border: 1.5px solid #b4b4b4;
      background: #fff;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.15s, transform 0.1s, box-shadow 0.1s, border-color 0.1s;
      font-weight: 500;
      width: 100%;
      max-width: 360px;
    }

    .btn.primary {
      border-color: var(--accent);
      color: var(--accent);
    }

    .btn:hover {
      background: #f4f4f4;
    }

    .btn.primary:hover {
      background: #e8f0ff;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .pair-container {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 14px;
    }

    .option {
      background:#fafafa;
      border:1px solid #ddd;
      border-radius:14px;
      padding:14px 12px;
      cursor:pointer;
      transition: background 0.15s, box-shadow 0.1s, transform 0.1s;
      text-align:center;
    }

    .option:hover {
      background:#fdfdfd;
      box-shadow:0 3px 12px rgba(0,0,0,0.06);
      transform:translateY(-1px);
    }

    .option-title {
      font-weight:600;
      font-size:1rem;
      line-height:1.5;
      word-break:keep-all;
    }

    .option-sub {
      font-size:.8rem;
      color:#777;
      margin-top:4px;
      line-height:1.4;
    }

    .progress-bar {
      width:100%;
      height:8px;
      background:#ddd;
      border-radius:10px;
      margin:10px 0 4px;
      overflow:hidden;
    }

    .progress-inner {
      background:var(--accent);
      width:0;
      height:100%;
      transition:width .25s;
    }

    .status {
      text-align:center;
      font-size:.85rem;
      margin-top:4px;
    }

    .bottom-link {
      margin-top:16px;
      text-align:center;
      font-size:0.8rem;
    }

    .bottom-link a {
      color: var(--accent);
      text-decoration: none;
    }

    .bottom-link a:hover {
      text-decoration: underline;
    }

    .results-list {
      list-style:none;
      padding:0;
      margin:8px 0 0;
    }

    .results-list li {
      padding:6px 4px;
      border-bottom:1px solid #eee;
      display:flex;
      gap:8px;
      font-size:0.9rem;
      line-height:1.5;
    }

    .rank-num {
      font-weight:bold;
      width:26px;
      text-align:right;
    }

    #unknownWrap h3 {
      margin:14px 0 6px;
      font-size:0.95rem;
    }

    .result-actions {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:8px;
      margin-bottom:12px;
      justify-content:center;
    }

    .result-actions .btn {
      max-width:200px;
    }

    .creator {
      margin-top: 18px;
      text-align: center;
      font-size: 0.8rem;
      color: #777;
    }
    .creator a {
      color: #007aff;
      text-decoration: none;
    }
    .creator a:hover {
      text-decoration: underline;
    }

    @media (min-width: 640px) {
      .pair-container {
        flex-direction: row;
      }
      .option {
        flex:1;
      }
    }

    @media (max-width: 480px) {
      h1 {
        font-size: 1.6rem;
      }
      .card {
        padding: 18px 14px 22px;
      }
      .btn {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
<div class="app">

  <!-- MODE SELECT -->
  <div class="card" id="startCard">
    <h1>BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆ</h1>
    <p class="sub">ãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚</p>

    <div class="mode-buttons">
      <button class="btn primary" onclick="start(false)">BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆ</button>
      <button class="btn" onclick="start(true)">BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆï¼ˆæ¼”åŠ‡å¥³å­éƒ¨å«ã‚€ï¼‰</button>
    </div>

    <p class="note">
      éŸ³æºãƒªãƒªãƒ¼ã‚¹æ¸ˆã¿ã§ãƒ¡ãƒ³ãƒãƒ¼ãŒæ­Œå”±ã—ãŸæ¥½æ›²ã®ã¿ã€‚<br>
      ã‚¢ãƒ«ãƒãƒ åéŒ²ã®å¯¸åŠ‡ãƒ»æ­Œå”±ç„¡ã—ã®ãƒˆãƒ©ãƒƒã‚¯ãªã©ã¯å…¥ã£ã¦ãŠã‚Šã¾ã›ã‚“ã€‚
    </p>

    <div class="creator">
      è£½ä½œè€… <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

  <!-- SORT UI -->
  <div class="card" id="compareCard" style="display:none;">
    <h1 id="modeTitle"></h1>

    <p class="sub">
      å¥½ããªæ›²ã‚’é¸æŠã—ç¶šã‘ã‚‹ã“ã¨ã§è‡ªåˆ†ã ã‘ã®BEYOOOOONDSæ¥½æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãŒä½œæˆã§ãã¾ã™ã€‚
    </p>

    <div class="status" id="statusText">0% å®Œäº†</div>
    <div class="progress-bar"><div class="progress-inner" id="progressInner"></div></div>

    <div class="pair-container">
      <div class="option" id="leftOption">
        <div class="option-title" id="leftTitle"></div>
        <div class="option-sub" id="leftAlbum"></div>
      </div>
      <div class="option" id="rightOption">
        <div class="option-title" id="rightTitle"></div>
        <div class="option-sub" id="rightAlbum"></div>
      </div>
    </div>

    <div style="text-align:center;margin-top:12px;display:flex;flex-direction:column;gap:8px;align-items:center;">
      <button class="btn primary" id="tieBtn">å¼•ãåˆ†ã‘</button>
      <button class="btn" id="backBtn" disabled>ã²ã¨ã¤æˆ»ã‚‹</button>
    </div>

    <div class="bottom-link">
      <a href="#" class="back-home">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
    </div>

    <div class="creator">
      è£½ä½œè€… <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

  <!-- RESULT -->
  <div class="card" id="resultCard" style="display:none;">
    <h1>çµæœ</h1>

    <!-- ğŸ”¼ ãƒœã‚¿ãƒ³ã‚’ä¸Šéƒ¨ã«ç§»å‹• -->
    <div class="result-actions">
      <button class="btn primary" id="saveBtn">çµæœã‚’ç”»åƒä¿å­˜</button>
      <button class="btn" id="shareBtn">Xã§çµæœã‚’å…±æœ‰</button>
    </div>

    <ol class="results-list" id="resultsList"></ol>

    <div id="unknownWrap" style="display:none;">
      <h3>çŸ¥ã‚‰ãªã„ ã«ã—ãŸæ›²</h3>
      <ul class="results-list" id="unknownList"></ul>
    </div>

    <div class="bottom-link">
      <a href="#" class="back-home">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
    </div>

    <div class="creator">
      è£½ä½œè€… <a href="https://x.com/beyomusicsort" target="_blank" rel="noopener noreferrer">@beyomusicsort</a>
    </div>
  </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
  // â˜… é›†è¨ˆå…ˆã® Apps Script URLï¼ˆã‚ãªãŸãŒé€ã£ã¦ãã‚ŒãŸæœ€æ–°ï¼‰
  const ENDPOINT_URL = "https://script.google.com/macros/s/AKfycbxVu5Y0TDyzDl3kRP_s1v9qt4N0xzkc-iXgb9s7XgB4HxU8wyRMDvqOKj5OcAE5FJfEWA/exec";

  // ----- æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ï¼šæœ€æ–°ãƒªã‚¹ãƒˆï¼‹ä¿®æ­£ãƒ»è¿½åŠ åæ˜  -----
  const fullSongsRaw = [
    "çœ¼é¡ã®ç”·ã®å­(1stã‚·ãƒ³ã‚°ãƒ«)",
    "Go Waist (1stã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ‹ãƒƒãƒãƒ³ãƒDãƒ»Nãƒ»Aï¼ (1stã‚·ãƒ³ã‚°ãƒ«)",
    "æ–‡åŒ–ç¥­å®Ÿè¡Œå§”é•·ã®æ‹(1stã‚·ãƒ³ã‚°ãƒ«)",
    "ã‚¢ãƒ„ã‚¤ï¼(BEYOOOOOND1St)",
    "ä¼¸ã³ã—ã‚ã€œBeyond the Worldã€œ(BEYOOOOOND1St)",
    "æ‹æ„›å¥‰è¡Œ(BEYOOOOOND1St)",
    "å…ƒå¹´ãƒãƒ³ã‚¸ãƒ¼ã‚¸ãƒ£ãƒ³ãƒ—(BEYOOOOOND1St)",
    "æ‹ã®ãŠã‚¹ã‚¦ã‚£ãƒ³ã‚°(BEYOOOOOND1St)",
    "ãã®ã“ãŸã‘ã®ã“å¤§æˆ¦è¨˜(BEYOOOOOND1St)",
    "ã“ã‚“ãªãƒã‚ºã‚¸ãƒ£ãƒŠã‚«ãƒƒã‚¿ãƒ¼ï¼(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒãƒ ã‚«ãƒ„é»™ç¤ºéŒ²(3rdã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ“ã‚¿ãƒŸãƒ³ME(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "Now Now Ningen(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "æ¿€è¾›LOVE (2ndã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ•ãƒ¬ãƒ•ãƒ¬ã‚¨ãƒ–ãƒªãƒ‡ã‚¤(é…ä¿¡ã‚·ãƒ³ã‚°ãƒ«)",
    "è‹±é›„ã€œç¬‘ã£ã¦ï¼ã‚·ãƒ§ãƒ‘ãƒ³å…ˆè¼©ã€œ(3rdã‚·ãƒ³ã‚°ãƒ«)",
    "Never Never Knowsã€œã‚³ãƒ¡æ´¾ã¨ãƒ‘ãƒ³æ´¾ã®ãƒ©ãƒ–ã‚¦ã‚©ãƒ¼ã‚ºã€œ(BEYOOOOOND2NDS)",
    "GOGOå¤§è‡£(BEYOOOOOND2NDS)",
    "ã‚ªãƒ³ãƒªãƒ¼ãƒ­ãƒ³ãƒªãƒ¼(BEYOOOOOND2NDS)",
    "è™è¦–ã‚¿ãƒ³ã‚¿ãƒ»ã‚¿ãƒ¼ãƒ³(BEYOOOOOND2NDS)",
    "Hey!ãƒ“ãƒ¨ãƒ³ãƒ€(BEYOOOOOND2NDS)",
    "æ±‚ã‚ã‚ˆâ€¦é‹å‘½ã®æ—…äººç®—(4thã‚·ãƒ³ã‚°ãƒ«)",
    "å¤¢ã•ãˆæã‘ãªã„å¤œç©ºã«ã¯(4thã‚·ãƒ³ã‚°ãƒ«)",
    "WORKERè®ƒæ­Œ(5thã‚·ãƒ³ã‚°ãƒ«)",
    "æ‹ã™ã‚‹éŠ€æ²³(5thã‚·ãƒ³ã‚°ãƒ«)",
    "Go City Go(5thã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ•ãƒƒã‚¯ã®æ³•å‰‡(5thã‚·ãƒ³ã‚°ãƒ«)",
    "ã‚ã‚å›ã«è»¢ç”Ÿ(6thã‚·ãƒ³ã‚°ãƒ«)",
    "Oh!ã‚«ãƒ³ã‚¿ãƒ¼ãƒ¬(5thã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒã‚¤ãƒ»ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆãƒ»ãƒ”ã‚¢ã‚¹(6thã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ‡ã‚£ã‚¹ã‚³ãƒ»ã‚«ãƒ¼ãƒ‹ãƒãƒ«(6thã‚·ãƒ³ã‚°ãƒ«)",
    "æ¶™ã®ã‚«ã‚¹ã‚¿ãƒãƒƒãƒˆ(BEYOOOOOND2NDS)",
    "ç°toãƒ€ã‚¤ãƒ¤ãƒ¢ãƒ³ãƒ‰(5thã‚·ãƒ³ã‚°ãƒ«)",
    "Do-Did-Done (6thã‚·ãƒ³ã‚°ãƒ«)",
    "éƒ½å–¶å¤§æ±Ÿæˆ¸ç·šã®å…­æœ¬æœ¨é§…ã§æŠ±ãã—ã‚ã¦(1st ã‚·ãƒ³ã‚°ãƒ«)",
    "GIRL ZONE (1stã‚·ãƒ³ã‚°ãƒ«)",
    "ãã“ã‚‰ã®å¥´ã¨ã¯åŒã˜ã«ã•ã‚ŒãŸããªã„(BEYOOOOOND1St)",
    "We Need a Name! (BEYOOOOOND1St)",
    "é«˜è¼ªã‚²ãƒ¼ãƒˆã‚¦ã‚§ã‚¤é§…ãŒã§ãã‚‹é ƒã«ã¯(BEYOOOOOND1St)",
    "ãƒ¯ã‚¿ã‚·ã¨è¸Šã‚Šãªã•ã„ï¼(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "ãƒ¤ãƒã‚¤æ‹ã®åˆƒ(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "äºŒå¹´å‰ã®æ¨ªæµœé§…è¥¿å£(2ndã‚·ãƒ³ã‚°ãƒ«)",
    "Get Backï¼ãƒ“ãƒ‹ãƒ¼ãƒ«å‚˜ã®å¤§å†’é™º(BEYOOOOOND2NDS)",
    "å¾ªç’°(BEYOOOOOND2NDS)",
    "å¾…ã¡åˆã‚ã›ã¯JRæ¢…ç”°é§…ã§(BEYOOOOOND2NDS)",
    "æœ€KOO DE DANCE(ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ãƒ³ã‚°ãƒ«)",

    "æœãŒæ¥ãŸ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "å§‹ã¾ã‚Šã®å…‰(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "é’æ˜¥ã‚’ä½œã‚ã†(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "ã¿ã‚“ãªã¨æ­©ã“ã†(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "æ°¸é ã«ãªã‚Œã°ã„ã„ã®ã«(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "çœ ã‚Œã‚‹æ£®ã®ç¾å¥³ã®ä¸–ç•Œ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "æ°¸é ã«ãªã‚Œã°ã„ã„ã®ã«2 (æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "æ°¸é ã«ãªã‚Œã°ã„ã„ã®ã«3 (æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "æ¯ã‚ŒãŸå£°(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "ã‚„ã‚ŠãªãŠãã†(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "çœ ã‚‹ã‚ãªãŸ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "å…‰ã¨é™°(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "ã¿ã‚“ãªã¨æ­©ã“ã†2 (æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "å¤œãŒæ¥ã¦ã€æœãŒæ¥ã‚‹(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",
    "å¤¢ã®ä¸–ç•Œ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œçœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨ã€)",

    "ãƒãƒªãƒ¼ã®ãƒ†ãƒ¼ãƒ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "BURBOOOOONS çˆ†èª•ï¼(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ãƒ¡ãƒ³ãƒãƒ¼ç´¹ä»‹ï¼(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆã‚¹ãƒ†ãƒƒãƒ—ï¼ï¼(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã„ã˜ã‚ã‚‹ãªäºŒäºº(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã¿ã‚“ãªã§ã²ã¨ã¤ã«(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ç¹‹ãŒã‚‰ãªã„å¿ƒ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "å›ãŒã„ã‚‹ã‹ã‚‰(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã“ã®æ„›ã‚’ã‚ãªãŸã«(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ãƒ«ã‚½ãƒ¼ã®æˆæ¥­(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã‚„ã£ã¦ã¿ã‚‹ã‚“ã (æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ç§˜å¯†(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã‚ãªãŸã«ã—ã‹ã§ããªã„ã“ã¨(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ãªã‚“ã©ã§ã‚‚(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ã¿ã‚“ãªã®ãŸã‚ã«(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",
    "ãƒ•ãƒ©ãƒ³ã‚¹ãƒ¬ãƒœãƒªãƒ¥ãƒ¼ã‚·ãƒ§ãƒ³(æ¼”åŠ‡å¥³å­éƒ¨ã€Œãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿ã€)",

    "æœ¬å½“ã®ã‚ãŸã—(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ä¿¡ã˜ã‚‹ã‚‚ã®ã€œãƒ›ãƒ³ãƒˆã®ã‚ãŸã—(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "å¥³ç‹ã®ã‚ªãƒ¼ãƒ‡ã‚£ã‚·ãƒ§ãƒ³(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "å‘¼ã³å(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ã¿ã‚“ãªãƒ©ã‚¤ãƒãƒ«(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "å¿ƒã‚’å©ãã‚ˆã†(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ç§ã®ãƒ•ã‚£ãƒ­ã‚½ãƒ•ã‚£ãƒ¼(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ç¶šã„ã¦ã‚‹(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "é‡ã„ç©ºæ°—(ãƒ©ãƒ™ãƒ³ãƒ€ï¼†ãƒ”ãƒ³ã‚¯) (æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "é‡ã„ç©ºæ°—(ãƒ–ãƒ«ãƒ¼ï¼†ã‚ªãƒ¬ãƒ³ã‚¸) (æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "é‡ã„ç©ºæ°—(ãƒ‡ã‚¤ã‚¸ãƒ¼ï¼†ãƒ›ãƒƒãƒ”ãƒ³) (æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",
    "ã‚ãŸã—ã®ä¸»å½¹(æ¼”åŠ‡å¥³å­éƒ¨ã€Œä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡ã€)",

    "å¤¢ã˜ã‚ƒãªã„(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ã‚¢ãƒ©ãƒ“ã‚¢ãƒ³ãƒ»ãƒ©ãƒ—ã‚½ãƒ‡ã‚£(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ãƒ¬ãƒƒãƒ‰ãƒ ãƒ¼ãƒ³(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "æœ€é«˜ã®ç‰©èª(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "æ‚ªã®ç‹(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "æœˆã«ã¯å¸°ã‚‰ãªã„(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "S4 (æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ã©ã†ã—ãŸã‚‰ã„ã„ã®(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "è¦ªå‹(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ã‚¸ãƒ©(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ã‚ã®é ƒ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "é¡˜ã„(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "å¹¾ã¤ã‚‚ã®å¤œã‚’ã‹ã‘(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",
    "ã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆ(æ¼”åŠ‡å¥³å­éƒ¨ã€Œã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆã€)",

    "æ„›ã¯ã¾ã‚‹ã§é™é›»æ°—(é…ä¿¡ã‚·ãƒ³ã‚°ãƒ«)",
    "æ˜Ÿã®ç¾ŠãŸã¡(Graduation Memorial CD)"
  ];

  const STAGE_KEYWORDS = [
    "æ¼”åŠ‡å¥³å­éƒ¨",
    "çœ ã‚Œã‚‹æ£®ã®ãƒ“ãƒ¨",
    "ã‚¢ãƒ©ãƒ“ãƒ¨ãƒ¼ãƒ³ã‚ºãƒŠã‚¤ãƒˆ",
    "ä¸æ€è­°ã®å›½ã®ã‚¢ãƒªã‚¹ãŸã¡",
    "ãƒ“ãƒ¨ã‚µã‚¤ãƒ¦å®®æ®¿"
  ];

  function isStageSong(str){
    return STAGE_KEYWORDS.some(k => str.includes(k));
  }

  // BEYOOOOOND1St / 2NDS ã‚’ã‚¢ãƒ«ãƒãƒ è¡¨è¨˜ã«ç½®æ›
  function cleanSong(str){
    return str
      .replace(/BEYOOOOOND1St/gi,"1stã‚¢ãƒ«ãƒãƒ ")
      .replace(/BEYOOOOOND2NDS/gi,"2ndã‚¢ãƒ«ãƒãƒ ");
  }

  // æœ€å¾Œã® () ã ã‘ã‚’åéŒ²å…ˆã¨ã—ã¦æ‰±ã†
  function parseSong(str){
    const lastOpen = str.lastIndexOf("(");
    const lastClose = str.lastIndexOf(")");
    if (lastOpen === -1 || lastClose === -1 || lastClose < lastOpen) {
      return { title: str.trim(), album: "" };
    }
    const title = str.slice(0, lastOpen).trim();
    const album = str.slice(lastOpen + 1, lastClose).trim();
    return { title, album };
  }

  let pool=[], ranked=[], unknown=[];
  let idx=0, low=0, high=0, mid=0, candidate="";
  let currentModeIncludeStage=false;
  let history = [];

  const startCard   = document.getElementById("startCard");
  const compareCard = document.getElementById("compareCard");
  const resultCard  = document.getElementById("resultCard");
  const modeTitle   = document.getElementById("modeTitle");
  const statusText  = document.getElementById("statusText");
  const progressInner = document.getElementById("progressInner");
  const leftOption  = document.getElementById("leftOption");
  const rightOption = document.getElementById("rightOption");
  const leftTitle   = document.getElementById("leftTitle");
  const leftAlbum   = document.getElementById("leftAlbum");
  const rightTitle  = document.getElementById("rightTitle");
  const rightAlbum  = document.getElementById("rightAlbum");
  const resultsList = document.getElementById("resultsList");
  const unknownWrap = document.getElementById("unknownWrap");
  const unknownList = document.getElementById("unknownList");
  const saveBtn     = document.getElementById("saveBtn");
  const shareBtn    = document.getElementById("shareBtn");
  const backBtn     = document.getElementById("backBtn");
  const tieBtn      = document.getElementById("tieBtn");

  document.querySelectorAll(".back-home").forEach(a=>{
    a.addEventListener("click", e=>{
      e.preventDefault();
      goHome();
    });
  });

  function updateBackButton(){
    backBtn.disabled = history.length === 0;
  }

  function goHome(){
    startCard.style.display="block";
    compareCard.style.display="none";
    resultCard.style.display="none";

    pool=[]; ranked=[]; unknown=[];
    idx=0; low=0; high=0; mid=0; candidate="";
    history=[];
    statusText.textContent = "0% å®Œäº†";
    progressInner.style.width = "0%";
    updateBackButton();
  }

  function start(includeStage){
    currentModeIncludeStage = includeStage;

    startCard.style.display="none";
    compareCard.style.display="block";
    resultCard.style.display="none";

    let list = fullSongsRaw.slice();
    if(!includeStage){
      list = list.filter(s => !isStageSong(s));
    }
    pool = list.map(cleanSong).sort(()=>Math.random()-0.5);

    ranked = [];
    unknown = [];
    history = [];
    updateBackButton();

    idx=0;

    ranked.push(pool[0]);
    idx=1;
    updateProgress();

    modeTitle.textContent = includeStage
      ? "BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆï¼ˆæ¼”åŠ‡å¥³å­éƒ¨å«ã‚€ï¼‰"
      : "BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆ";

    nextStep();
  }

  function updateProgress(){
    const percent = pool.length ? Math.floor((idx / pool.length) * 100) : 0;
    statusText.textContent = `${percent}% å®Œäº†`;
    progressInner.style.width = percent + "%";
  }

  function nextStep(){
    if(idx >= pool.length){
      finish();
      return;
    }
    candidate = pool[idx];
    low = 0;
    high = ranked.length;
    ask();
  }

  function ask(){
    if(low >= high){
      ranked.splice(low,0,candidate);
      idx++;
      updateProgress();
      nextStep();
      return;
    }
    mid = Math.floor((low+high)/2);
    showPair(candidate, ranked[mid]);
  }

  function showPair(a,b){
    const L = parseSong(a);
    const R = parseSong(b);
    leftTitle.textContent = L.title;
    leftAlbum.textContent = L.album;
    rightTitle.textContent = R.title;
    rightAlbum.textContent = R.album;
  }

  function saveStateForUndo(){
    history.push({
      pool: pool.slice(),
      ranked: ranked.slice(),
      unknown: unknown.slice(),
      idx,
      low,
      high,
      mid,
      candidate,
      currentModeIncludeStage
    });
    updateBackButton();
  }

  leftOption.onclick = () => {
    saveStateForUndo();
    high = mid;
    ask();
  };

  rightOption.onclick= () => {
    saveStateForUndo();
    low  = mid+1;
    ask();
  };

  tieBtn.onclick = () => {
    saveStateForUndo();
    low = mid+1;
    high = mid+1;
    ask();
  };

  backBtn.addEventListener("click", () => {
    if(!history.length) return;
    const state = history.pop();
    pool = state.pool.slice();
    ranked = state.ranked.slice();
    unknown = state.unknown.slice();
    idx = state.idx;
    low = state.low;
    high = state.high;
    mid = state.mid;
    candidate = state.candidate;
    currentModeIncludeStage = state.currentModeIncludeStage;
    updateProgress();
    updateBackButton();

    if (ranked[mid]) {
      showPair(candidate, ranked[mid]);
      compareCard.style.display="block";
      resultCard.style.display="none";
    }
  });

  function finish(){
    compareCard.style.display="none";
    resultCard.style.display="block";

    resultsList.innerHTML = "";
    ranked.forEach((s,i)=>{
      const parsed = parseSong(s);
      const li = document.createElement("li");
      li.innerHTML =
        `<span class="rank-num">${i+1}.</span>` +
        `<span><strong>${parsed.title}</strong><br><span style="font-size:0.8rem;color:#666;">${parsed.album}</span></span>`;
      resultsList.appendChild(li);
    });

    if(unknown.length){
      unknownWrap.style.display="block";
      unknownList.innerHTML = "";
      unknown.forEach(s=>{
        const parsed = parseSong(s);
        const li = document.createElement("li");
        li.innerHTML =
          `<span class="rank-num">-</span>` +
          `<span><strong>${parsed.title}</strong><br><span style="font-size:0.8rem;color:#666;">${parsed.album}</span></span>`;
        unknownList.appendChild(li);
      });
    }else{
      unknownWrap.style.display="none";
    }

    sendResultToSheet();
  }

  function sendResultToSheet(){
    if (!ENDPOINT_URL) return;

    const payload = {
      mode: currentModeIncludeStage ? "stage" : "normal",
      ranked: ranked,
      unknown: unknown,
      ua: navigator.userAgent
    };

    try {
      fetch(ENDPOINT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify(payload)
      });
    } catch (e) {
      console.warn("é€ä¿¡å‡¦ç†ã‚¨ãƒ©ãƒ¼(ç„¡è¦–OK):", e);
    }
  }

  saveBtn.addEventListener("click", ()=>{
    html2canvas(resultCard).then(canvas=>{
      const a=document.createElement("a");
      a.href=canvas.toDataURL("image/png");
      a.download="BEYOOOOONDS_sort_result.png";
      a.click();
    });
  });

  shareBtn.addEventListener("click", ()=>{
    if(!ranked.length) return;
    const top = ranked.slice(0,5)
      .map((s,i)=>`${i+1}. ${parseSong(s).title}`)
      .join(" / ");
    const text = `BEYOOOOONDSæ¥½æ›²ã‚½ãƒ¼ãƒˆ çµæœ\n${top}\n\n#ãƒ“ãƒ¨æ›²ã‚½ãƒ¼ãƒˆ`;
    const url  = location.href;
    const shareUrl =
      "https://twitter.com/intent/tweet?text=" +
      encodeURIComponent(text) +
      "&url=" +
      encodeURIComponent(url);
    window.open(shareUrl,"_blank");
  });
</script>
</body>
</html>
